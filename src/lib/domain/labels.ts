'use client';

import QRCode from 'qrcode';
import { jsPDF } from 'jspdf';
import { LabelFormat, Order } from './types';

let cachedLogoDataUrl: string | null = null;

async function getLogoDataUrl() {
  if (cachedLogoDataUrl) return cachedLogoDataUrl;

  try {
    const res = await fetch('/logo.png');
    if (!res.ok) return null;
    const blob = await res.blob();
    const reader = new FileReader();
    const dataUrl = await new Promise<string>((resolve, reject) => {
      reader.onloadend = () => resolve(reader.result as string);
      reader.onerror = () => reject(new Error('Failed to read logo image'));
      reader.readAsDataURL(blob);
    });
    cachedLogoDataUrl = dataUrl;
    return dataUrl;
  } catch {
    return null;
  }
}

function shortDate(value?: string): string {
  if (!value) return '';
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return String(value);
  return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()} ${String(
    d.getHours()
  ).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
}

function simpleDate(value?: string): string {
  if (!value) return '';
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return String(value);
  return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
}

async function addQr(
  pdf: any,
  order: Order,
  pageIndex: number,
  format: LabelFormat,
  x: number,
  y: number,
  size: number
) {
  const payload = `${order.orderNumber}|${format}|PAGE:${pageIndex + 1}`;
  const qrDataUrl = await QRCode.toDataURL(payload, { margin: 1, width: 180 });
  pdf.addImage(qrDataUrl, 'PNG', x, y, size, size);
}

type LabelRenderContext = {
  pdf: any;
  order: Order;
  pickerName?: string;
  pageIndex: number;
};

async function renderExitLabel({ pdf, order, pickerName, pageIndex }: LabelRenderContext) {
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 4;
  const innerWidth = pageWidth - margin * 2;
  const baseItem = order.items[pageIndex] ?? order.items[0] ?? { 
    materialName: 'Material', 
    color: 'Cor', 
    qtySeparated: 0, 
    qtyRequested: 0, 
    uom: 'EA',
    conditions: []
  };
  // Garantir que conditions é sempre um array
  const item = {
    ...baseItem,
    conditions: (baseItem.conditions && Array.isArray(baseItem.conditions)) ? baseItem.conditions : []
  };
  const peso = Math.max(item.qtySeparated, item.qtyRequested);
  const volume = `${pageIndex + 1}/${Math.max(1, order.volumeCount)}`;

  pdf.setDrawColor(0);
  pdf.setLineWidth(0.8);
  pdf.rect(margin, margin, innerWidth, pageHeight - margin * 2);

  const logoY = margin + 6;
  const logoSize = 30;
  const logoDataUrl = await getLogoDataUrl();
  if (logoDataUrl) {
    pdf.addImage(logoDataUrl, 'PNG', pageWidth / 2 - logoSize / 2, logoY, logoSize, logoSize);
  }

  pdf.setFontSize(18);
  pdf.text('São José Cordas', pageWidth / 2, logoY + logoSize + 6, { align: 'center' });

  const detailX = margin + 6;
  const detailStartY = logoY + logoSize + 12;
  const lines = [
    ['Pedido', order.orderNumber],
    ['Data', simpleDate(order.dueDate ?? order.orderDate)],
    ['Tipo', item.materialName],
    ['Desc', item.description ?? item.materialName],
    ['Cor', item.color],
    ['Peso', `${peso} ${item.uom}`],
    ['Pac.', volume],
    ['Separador', pickerName ?? '-'],
  ];
  const warrantyHeight = 32;
  const warrantyY = pageHeight - margin - warrantyHeight;
  const bottomLimit = warrantyY - 4;

  pdf.setFontSize(10);
  const lineHeight = 4.8;
  let detailY = detailStartY;
  for (const [label, value] of lines) {
    if (detailY >= bottomLimit - 6) break;
    pdf.text(`${label}: ${value}`, detailX, detailY);
    detailY += lineHeight;
  }

  const conditions = Array.isArray(item.conditions) ? item.conditions : [];
  if (conditions.length > 0) {
    const condLineHeight = 3.6;
    const conditionBlockHeight = 3.5 + conditions.length * condLineHeight;
    const conditionsStartY = detailY + 4;
    if (conditionsStartY + conditionBlockHeight <= bottomLimit - 2) {
      pdf.setFontSize(7.5);
      pdf.text('Condições:', detailX, conditionsStartY);
      let currentY = conditionsStartY + 3.5;
      pdf.setFontSize(6.5);
      for (const cond of conditions) {
        if (currentY + condLineHeight > bottomLimit - 2) break;
        const condText = `${cond.key}: ${cond.value}`;
        pdf.text(condText.slice(0, 50), detailX, currentY);
        currentY += condLineHeight;
      }
      detailY = currentY;
    }
  }

  const itemsLabelY = detailY + 6;
  if (itemsLabelY < bottomLimit - 6) {
    pdf.setFontSize(11);
    pdf.text('Itens', detailX, itemsLabelY);
    const itemsDetailY = itemsLabelY + 5;
    if (itemsDetailY < bottomLimit - 2) {
      const qty = Math.max(item.qtySeparated, item.qtyRequested);
      pdf.setFontSize(9);
      const itemText = `${item.materialName} | ${item.color} | ${qty} ${item.uom}`;
      pdf.text(itemText.slice(0, 45), detailX, itemsDetailY);
    }
  }

  pdf.setFontSize(6.8);
  const warrantyText =
    'Garantia de 1 ano contra defeitos de fabricação ou material, válida a partir da data da compra mediante apresentação do comprovante. Em caso de falha, interrompa o uso e contate imediatamente o fornecedor. A garantia não cobre danos causados por uso inadequado durante a fabricação.';
  pdf.text(warrantyText, margin + 6, warrantyY + 6, { maxWidth: innerWidth - 12 });
  pdf.text('** Não trocamos material já utilizado **', margin + 6, warrantyY + warrantyHeight - 8);

  pdf.setFontSize(6.5);
  pdf.text(`Impresso em ${shortDate(new Date().toISOString())}`, margin + 6, pageHeight - margin - 4);
}

async function renderProductionLabel({ pdf, order, pickerName, pageIndex }: LabelRenderContext) {
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 4;
  const baseItem = order.items[0] ?? { 
    materialName: 'Material', 
    color: 'Cor', 
    qtySeparated: 0, 
    qtyRequested: 0, 
    uom: 'EA',
    conditions: []
  };
  // Garantir que conditions é sempre um array
  const item = {
    ...baseItem,
    conditions: (baseItem.conditions && Array.isArray(baseItem.conditions)) ? baseItem.conditions : []
  };
  const peso = Math.max(item.qtySeparated, item.qtyRequested);
  const logoY = margin + 4;
  const logoSize = 22;

  pdf.setDrawColor(0);
  pdf.setLineWidth(0.6);
  pdf.rect(margin, margin, pageWidth - margin * 2, pageHeight - margin * 2);

  const logoDataUrl = await getLogoDataUrl();
  if (logoDataUrl) {
    pdf.addImage(logoDataUrl, 'PNG', pageWidth / 2 - logoSize / 2, logoY, logoSize, logoSize);
  }

  pdf.setFontSize(14);
  pdf.text('São José Cordas', pageWidth / 2, logoY + logoSize + 8, { align: 'center' });
  const detailX = margin + 6;
  let detailY = logoY + logoSize + 16;
  pdf.setFontSize(10);
  const lineHeight = 5;
  const fields = [
    ['Lote', order.orderNumber],
    ['Data', simpleDate(order.orderDate)],
    ['Tipo', item.materialName],
    ['Desc', item.description ?? item.materialName],
    ['Cor', item.color],
    ['Peso', `${peso} ${item.uom}`],
    ['Separador', pickerName ?? '-'],
    ['Pac.', `${pageIndex + 1}/${Math.max(1, order.volumeCount)}`],
  ];
  
  const maxFieldsY = pageHeight - margin - 12; // Espaço reservado para o QR e texto final
  fields.forEach(([label, value]) => {
    if (detailY < maxFieldsY) {
      pdf.text(`${label}: ${value}`, detailX, detailY);
      detailY += lineHeight;
    }
  });

  detailY = Math.max(detailY + 2, maxFieldsY); // Garante espaço mínimo antes do texto final
  pdf.setFontSize(8);
  pdf.text('Etiqueta de produção para colar após concluir o processo.', detailX, detailY, { maxWidth: pageWidth - detailX - 28 });
  
  await addQr(pdf, order, pageIndex, 'PRODUCTION_4x4', pageWidth - margin - 26, margin + 4, 24);
}

export async function generateLabelPdf(order: Order, pickerName?: string, format: LabelFormat = 'EXIT_10x15'): Promise<void> {
  const dimensions = format === 'EXIT_10x15' ? [100, 150] : [40, 40];
  const pdf = new jsPDF({ unit: 'mm', format: dimensions });
  const render = format === 'EXIT_10x15' ? renderExitLabel : renderProductionLabel;
  const pageCount = format === 'EXIT_10x15' ? Math.max(1, order.volumeCount) : 1;

  for (let pageIndex = 0; pageIndex < pageCount; pageIndex += 1) {
    if (pageIndex !== 0) pdf.addPage();
    await render({ pdf, order, pickerName, pageIndex });
  }

  pdf.save(`etiquetas-${order.orderNumber}-${format}.pdf`);
}
